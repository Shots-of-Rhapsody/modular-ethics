<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="assets/site.css">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interactive â€” Exports & Sensitivity | Ethics Testbed</title>
  <meta name="theme-color" content="#00A86B">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --jade:#00A86B; --muted:#6b7280; --radius:14px; --maxw:1200px; }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#fafcff; color:#111827; }
    header{ position:sticky; top:0; backdrop-filter:saturate(120%) blur(10px); background:#ffffffc7; border-bottom:1px solid #e5e7eb; }
    .wrap{ max-width:var(--maxw); margin:0 auto; padding:0 20px; }
    .nav{ display:flex; align-items:center; justify-content:space-between; height:64px; }
    h1,h2{ font-family:"Playfair Display", Georgia, serif; }
    h1{ margin:16px 0; font-size:clamp(28px,4vw,40px); }
    h2{ margin:18px 0 10px; font-size:clamp(22px,3vw,30px); }
    .kicker{ display:inline-flex; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--jade); background:#00a86b1a; }
    .grid{ display:grid; gap:16px; grid-template-columns:1fr; }
    @media (min-width:1100px){ .grid{ grid-template-columns:360px 1fr; } }
    .card{ background:white; border:1px solid #e5e7eb; border-radius:var(--radius); padding:16px; box-shadow:0 12px 34px -24px rgba(0,0,0,.2); }
    .muted{ color:var(--muted); }
    .btn{ display:inline-block; font-weight:700; padding:10px 16px; border-radius:999px; background:var(--jade); color:#fff; text-decoration:none; box-shadow:0 6px 18px -8px rgba(0,168,107,.25), 0 2px 6px -2px rgba(0,168,107,.25); }
    .btn.ghost{ background:transparent; color:var(--jade); border:1px solid var(--jade); }
    .row{ display:grid; gap:10px; grid-template-columns: 1fr auto; align-items:center; }
    .ctrl{ display:grid; gap:8px; margin-bottom:14px; }
    .ctrl label{ font-size:12px; color:#374151; display:flex; justify-content:space-between; }
    input[type="range"]{ width:100%; }
    .badge{ font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .hr{ height:1px; background:#e5e7eb; margin:12px 0; }
    canvas{ width:100%; height:auto; image-rendering: crisp-edges; border-radius:12px; border:1px solid #e5e7eb; background:#fff; }
    .legend{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .swatch{ width:14px; height:14px; border-radius:3px; display:inline-block; border:1px solid #0001; }
    code{ background:#0d1117; color:#e5e7eb; padding:2px 6px; border-radius:8px; font-size:12px; }
    table{ width:100%; border-collapse:collapse; margin-top:14px; }
    th,td{ padding:8px 10px; border-bottom:1px solid #e5e7eb; font-size:14px; text-align:left; }
    th{ background:#f8fafc; }
  </style>
</head>
<body>
<header>
  <div class="nav-container">
    <nav class="site-nav">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/contribute.html">Contribute</a></li>
        <li><a href="/interactive.html">Interactive</a></li>
        <li><a href="/language-math.html">Language &amp; Math</a></li>
        <li><a href="/paper.html">Paper</a></li>
        <li><a href="/research.html">Research</a></li>
        <li><a href="/results.html">Results</a></li>
        <li><a href="/stories.html">Stories</a></li>
        <li><a href="/contact/">Contact</a></li>
        <li><a href="/testing-index.html">Testing Index</a></li>
      </ul>
    </nav>

    <div class="nav-cta">
      <button class="theme" id="themeBtn" aria-label="Toggle theme" title="Toggle theme">ðŸŒ“</button>
      <a class="btn outline" href="https://github.com/xartaiusx/ethics.testbed" target="_blank" rel="noopener">
        View Repo
      </a>
      <button class="menu" id="menuBtn" aria-label="Open menu">â˜°</button>
    </div>
  </div>
</header>

  <main class="wrap">
    <h1>Exports & Sensitivity</h1>
    <p class="muted">
      Tune credences across Consequentialism, Rawls, and Virtue; toggle the promise rule; export runs; and see sensitivity across p<sub>cons</sub> and Î¸.
    </p>

    <div class="grid">
      <!-- Controls -->
      <div class="card" id="controls">
        <h2>Controls</h2>

        <div class="ctrl">
          <label>Consequentialism weight <span><code id="lab_pcons">0.50</code></span></label>
          <input id="p_cons" type="range" min="0" max="1" step="0.01" value="0.50">
        </div>
        <div class="ctrl">
          <label>Rawls weight <span><code id="lab_prawls">0.25</code></span></label>
          <input id="p_rawls" type="range" min="0" max="1" step="0.01" value="0.25">
        </div>
        <div class="ctrl">
          <label>Virtue weight <span><code id="lab_pvirtue">0.25</code></span></label>
          <input id="p_virtue" type="range" min="0" max="1" step="0.01" value="0.25">
          <small class="muted">Scalar credences renormalize so the three sum to 1.</small>
        </div>

        <div class="hr"></div>

        <div class="ctrl">
          <label>Promise constraint enabled <span class="badge" id="lab_promise">ON</span></label>
          <div class="row">
            <input id="promise_enabled" type="checkbox" checked>
            <small class="muted">Affects <code>evac-promise-v1</code></small>
          </div>
        </div>

        <div class="ctrl">
          <label>Promise override threshold Î¸ (Î” lives) <span><code id="lab_theta">1.50</code></span></label>
          <input id="theta_lives" type="range" min="0" max="3" step="0.05" value="1.50">
        </div>

        <div class="hr"></div>

        <h3>Virtue trait weights</h3>
        <div class="ctrl">
          <label>Honesty <span><code id="lab_honesty">1.00</code></span></label>
          <input id="w_honesty" type="range" min="0" max="3" step="0.05" value="1.00">
        </div>
        <div class="ctrl">
          <label>Compassion <span><code id="lab_compassion">1.00</code></span></label>
          <input id="w_compassion" type="range" min="0" max="3" step="0.05" value="1.00">
        </div>
        <div class="ctrl">
          <label>Fairness <span><code id="lab_fairness">1.00</code></span></label>
          <input id="w_fairness" type="range" min="0" max="3" step="0.05" value="1.00">
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="exportRun">Download current run (JSON)</button>
          <a class="btn ghost" href="results.html">Table view</a>
        </div>
      </div>

      <!-- Viz + output -->
      <div class="card">
        <h2>Sensitivity Map</h2>
        <p class="muted">
          Heatmap of the <strong>evacuation</strong> recommendation across p<sub>cons</sub> (x) and Î¸ (y), holding p<sub>rawls</sub> fixed (virtue = 1 âˆ’ p<sub>cons</sub> âˆ’ p<sub>rawls</sub>).
        </p>
        <canvas id="chart" width="800" height="520" aria-label="Sensitivity heatmap"></canvas>
        <div class="legend" id="legend"></div>

        <h2 style="margin-top:18px">Current Recommendation</h2>
        <div id="rec"></div>

        <h2 style="margin-top:18px">Current Scores</h2>
        <div id="scores"></div>
      </div>
    </div>

    <p style="margin-top:18px"><a class="btn" href="index.html">Back to Home</a></p>
  </main>

  <footer class="wrap" style="margin:30px 0 60px; color:#6b7280">
    Â© <span id="y"></span> Ethics Testbed Â· MIT License
  </footer>

  <script src="js/engine.js"></script>
  <script>
    // ---- State & UI wiring ----
    const defaults = {
      credences: { p_cons: 0.5, p_rawls: 0.25, p_virtue: 0.25 },
      promise: { enabled: true, theta_lives: 1.5 },
      virtueWeights: { honesty: 1.0, compassion: 1.0, fairness: 1.0 }
    };
    const state = JSON.parse(JSON.stringify(defaults));

    const ui = {
      p_cons: document.getElementById('p_cons'),
      p_rawls: document.getElementById('p_rawls'),
      p_virtue: document.getElementById('p_virtue'),
      lab_pcons: document.getElementById('lab_pcons'),
      lab_prawls: document.getElementById('lab_prawls'),
      lab_pvirtue: document.getElementById('lab_pvirtue'),

      promise_enabled: document.getElementById('promise_enabled'),
      theta_lives: document.getElementById('theta_lives'),
      lab_promise: document.getElementById('lab_promise'),
      lab_theta: document.getElementById('lab_theta'),

      w_honesty: document.getElementById('w_honesty'),
      w_compassion: document.getElementById('w_compassion'),
      w_fairness: document.getElementById('w_fairness'),
      lab_honesty: document.getElementById('lab_honesty'),
      lab_compassion: document.getElementById('lab_compassion'),
      lab_fairness: document.getElementById('lab_fairness'),

      exportRun: document.getElementById('exportRun')
    };

    document.getElementById('y').textContent = (new Date()).getFullYear();

    let scenarios = [];
    async function loadScenarios() {
      const res = await fetch('data/scenarios.json');
      if (!res.ok) throw new Error('Failed to load scenarios.json');
      const j = await res.json();
      scenarios = j.scenarios;
    }

    // Renormalize three weights to sum=1
    function renormCredences() {
      let c = parseFloat(ui.p_cons.value);
      let r = parseFloat(ui.p_rawls.value);
      let v = parseFloat(ui.p_virtue.value);
      const s = c + r + v;
      if (s <= 0) { c = 1; r = 0; v = 0; }
      else { c /= s; r /= s; v /= s; }
      state.credences.p_cons = c; state.credences.p_rawls = r; state.credences.p_virtue = v;
      ui.lab_pcons.textContent = c.toFixed(2);
      ui.lab_prawls.textContent = r.toFixed(2);
      ui.lab_pvirtue.textContent = v.toFixed(2);
    }
    function syncPromise() {
      state.promise.enabled = ui.promise_enabled.checked;
      state.promise.theta_lives = parseFloat(ui.theta_lives.value);
      ui.lab_promise.textContent = state.promise.enabled ? 'ON' : 'OFF';
      ui.lab_theta.textContent = state.promise.theta_lives.toFixed(2);
    }
    function syncVirtueWeights() {
      state.virtueWeights.honesty = parseFloat(ui.w_honesty.value);
      state.virtueWeights.compassion = parseFloat(ui.w_compassion.value);
      state.virtueWeights.fairness = parseFloat(ui.w_fairness.value);
      ui.lab_honesty.textContent = state.virtueWeights.honesty.toFixed(2);
      ui.lab_compassion.textContent = state.virtueWeights.compassion.toFixed(2);
      ui.lab_fairness.textContent = state.virtueWeights.fairness.toFixed(2);
    }

    // Export current run JSON
    function download(filename, obj) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    function runAll() {
      const evals = scenarios.map(s => window.EthicsEngine.evaluateScenario(s, state));
      return {
        timestamp: new Date().toISOString(),
        ledger_version: "0.1",
        settings: JSON.parse(JSON.stringify(state)),
        scenarios: scenarios.map(s => s.id),
        results: evals.map(ev => ({
          scenarioId: ev.scenarioId,
          ranking: ev.ranking,
          admissibility: Array.from(ev.admissibility.entries()),
          explanations: ev.explanations
        }))
      };
    }
    ui.exportRun.addEventListener('click', () => {
      const bundle = runAll();
      download(`ethics-testbed-run-${new Date().toISOString().slice(0,10)}.json`, bundle);
    });

    // Sensitivity map (p_cons vs Î¸), holding p_rawls fixed; virtue = 1 - p_cons - p_rawls (clamped â‰¥0)
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const legend = document.getElementById('legend');
    const recDiv = document.getElementById('rec');
    const scoresDiv = document.getElementById('scores');

    const COLORS = {
      a1_allocate_A: '#2563eb', a2_allocate_B: '#10b981', a3_lottery: '#f59e0b',
      b1_east_now: '#9333ea', b2_west_plus_one_east: '#ef4444', b3_mixed_break_promise: '#3b82f6'
    };
    function drawLegend(items) {
      legend.innerHTML = items.map(([k,label]) =>
        `<span><span class="swatch" style="background:${COLORS[k]};"></span> ${label}</span>`
      ).join(' ');
    }

    function evaluateTopActionWith(pCons, theta, promiseOn, pRawlsFix) {
      const pVirt = Math.max(0, 1 - pCons - pRawlsFix);
      const settings = {
        credences: { p_cons: pCons, p_rawls: pRawlsFix, p_virtue: pVirt },
        promise: { enabled: promiseOn, theta_lives: theta },
        virtueWeights: state.virtueWeights
      };
      const evac = scenarios.find(s=>s.id==="evac-promise-v1");
      const ev = window.EthicsEngine.evaluateScenario(evac, settings);
      return ev.ranking[0]?.[0] || null;
    }

    function renderSensitivity() {
      const W = canvas.width, H = canvas.height;
      const padL = 54, padB = 42, padT = 20, padR = 16;
      const plotW = W - padL - padR, plotH = H - padT - padB;
      ctx.clearRect(0,0,W,H);

      const NX = 50, NY = 50;
      const pRawlsFix = state.credences.p_rawls;

      for (let iy=0; iy<NY; iy++) {
        const theta = 3 * (iy/(NY-1));
        for (let ix=0; ix<NX; ix++) {
          const pCons = ix/(NX-1);
          const a = evaluateTopActionWith(pCons, state.promise.enabled ? theta : state.promise.theta_lives, state.promise.enabled, pRawlsFix);
          const color = COLORS[a] || '#9ca3af';
          const x = padL + Math.floor(ix*plotW/NX);
          const y = padT + Math.floor((NY-1-iy)*plotH/NY);
          const cw = Math.ceil(plotW/NX)+1;
          const ch = Math.ceil(plotH/NY)+1;
          ctx.fillStyle = color; ctx.fillRect(x, y, cw, ch);
        }
      }

      // Axes
      ctx.strokeStyle = '#111827'; ctx.lineWidth = 1; ctx.strokeRect(padL, padT, plotW, plotH);
      ctx.fillStyle = '#111827'; ctx.font = '12px Inter, system-ui, sans-serif';
      for (let t=0; t<=10; t+=2) {
        const p = t/10, x = padL + p*plotW;
        ctx.beginPath(); ctx.moveTo(x, padT+plotH); ctx.lineTo(x, padT+plotH+6); ctx.stroke();
        ctx.fillText(p.toFixed(1), x-8, padT+plotH+20);
      }
      ctx.fillText('p_cons (virtue = 1 âˆ’ p_cons âˆ’ p_rawls)', padL + plotW/2 - 110, H-8);
      for (let t=0; t<=6; t+=1) {
        const th = (t/2), y = padT + (1 - th/3)*plotH;
        ctx.beginPath(); ctx.moveTo(padL-6, y); ctx.lineTo(padL, y); ctx.stroke();
        ctx.fillText(th.toFixed(1), 8, y+4);
      }
      ctx.save(); ctx.translate(12, padT + plotH/2); ctx.rotate(-Math.PI/2);
      ctx.fillText('Î¸ (Î” lives to override promise)', -90, 0);
      ctx.restore();

      drawLegend([
        ['b1_east_now', 'Keep promise (East now)'],
        ['b2_west_plus_one_east', 'Break promise (West+1 East)'],
        ['b3_mixed_break_promise', 'Mixed (incl. D1)']
      ]);

      // Current recommendations + table for current settings (both scenarios)
      const triage = scenarios.find(s=>s.id==="triage-vent-v1");
      const evac   = scenarios.find(s=>s.id==="evac-promise-v1");
      const evT = window.EthicsEngine.evaluateScenario(triage, state);
      const evE = window.EthicsEngine.evaluateScenario(evac, state);

      document.getElementById('rec').innerHTML = `
        <p>Triage: <code>${evT.ranking[0]?.[0] || 'â€”'}</code></p>
        <p>Evacuation: <code>${evE.ranking[0]?.[0] || 'â€”'}</code> (promise ${state.promise.enabled ? 'ON' : 'OFF'}, Î¸=${state.promise.theta_lives.toFixed(2)})</p>
      `;

      // Score table (current state)
      const acts = (s) => s.actions.map(a=>a.id);
      const row = (ev, id) => `
        <tr>
          <td><code>${id}</code></td>
          <td>${(ev.consNorm.get(id)??NaN).toFixed(3)}</td>
          <td>${(ev.rawlsNorm.get(id)??NaN).toFixed(3)}</td>
          <td>${(ev.virtueNorm.get(id)??NaN).toFixed(3)}</td>
          <td>${(ev.aggregate.get(id)??NaN).toFixed(3)}</td>
        </tr>`;
      scoresDiv.innerHTML = `
        <table>
          <thead><tr><th>Action</th><th>Cons</th><th>Rawls</th><th>Virtue</th><th>Aggregate</th></tr></thead>
          <tbody>
            <tr><th colspan="5">triage-vent-v1</th></tr>
            ${acts(triage).map(id=>row(evT,id)).join('')}
            <tr><th colspan="5">evac-promise-v1</th></tr>
            ${acts(evac).map(id=>row(evE,id)).join('')}
          </tbody>
        </table>`;
    }

    // Bind UI
    ['p_cons','p_rawls','p_virtue'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => { renormCredences(); renderSensitivity(); });
    });
    document.getElementById('promise_enabled').addEventListener('change', () => { syncPromise(); renderSensitivity(); });
    document.getElementById('theta_lives').addEventListener('input', () => { syncPromise(); renderSensitivity(); });
    ['w_honesty','w_compassion','w_fairness'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => { syncVirtueWeights(); renderSensitivity(); });
    });

    // Boot
    (async function main(){
      renormCredences(); syncPromise(); syncVirtueWeights();
      await loadScenarios();
      renderSensitivity();
    })();
  </script>
  <script src="assets/site.js"></script>
</body>
</html>
