<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="assets/site.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interactive Results - Ethics Testbed</title>
  <meta name="description" content="Adjust credences, promise thresholds, and virtue weights. See how recommendations change." />
  <meta name="theme-color" content="#00A86B" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />
</head>
<body>
<header>
  <div class="nav-container">
    <nav class="site-nav">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/contribute.html">Contribute</a></li>
        <li><a href="/interactive.html">Interactive</a></li>
        <li><a href="/language-math.html">Language &amp; Math</a></li>
        <li><a href="/paper.html">Paper</a></li>
        <li><a href="/research.html">Research</a></li>
        <li><a href="/results.html">Results</a></li>
        <li><a href="/stories.html">Stories</a></li>
        <li><a href="/contact/">Contact</a></li>
      </ul>
    </nav>
    <div class="nav-cta">
      <button class="theme" id="themeBtn" aria-label="Toggle theme" title="Toggle theme">ðŸŒ“</button>
      <a class="btn outline" href="https://github.com/xartaiusx/ethics.testbed" target="_blank" rel="noopener">View Repo</a>
      <button class="menu" id="menuBtn" aria-label="Open menu">â˜°</button>
    </div>
  </div>
</header>

<main class="wrap">
  <h1 class="page-title">Results (Live)</h1>
  <p class="muted">Adjust parameters on the left. The tables recompute instantly. Deontic constraints gate actions before aggregation.</p>

  <div class="grid grid-results">
    <!-- Controls -->
    <div class="card" id="controls" aria-label="Controls">
      <h2>Controls</h2>

      <div class="ctrl">
        <label>Consequentialism weight <span><code id="lab_pcons">0.50</code></span></label>
        <input id="p_cons" type="range" min="0" max="1" step="0.01" value="0.50" />
      </div>

      <div class="ctrl">
        <label>Rawls weight <span><code id="lab_prawls">0.25</code></span></label>
        <input id="p_rawls" type="range" min="0" max="1" step="0.01" value="0.25" />
      </div>

      <div class="ctrl">
        <label>Virtue weight <span><code id="lab_pvirtue">0.25</code></span></label>
        <input id="p_virtue" type="range" min="0" max="1" step="0.01" value="0.25" />
        <small class="muted">Credences renormalize so the three sum to 1.</small>
      </div>

      <div class="bar" aria-hidden="true">
        <span class="c" id="bar_c" style="width:50%"></span>
        <span class="r" id="bar_r" style="width:25%"></span>
        <span class="v" id="bar_v" style="width:25%"></span>
      </div>

      <div class="hr"></div>

      <div class="ctrl">
        <label>Promise constraint <span class="badge" id="lab_promise">ON</span></label>
        <div class="row">
          <input id="promise_enabled" type="checkbox" checked />
          <small class="muted">Scenario: <code>evac-promise-v1</code></small>
        </div>
      </div>

      <div class="ctrl">
        <label>Promise override threshold Î¸ (Î” lives) <span><code id="lab_theta">1.50</code></span></label>
        <input id="theta_lives" type="range" min="0" max="3" step="0.05" value="1.50" />
      </div>

      <div class="hr"></div>

      <h3>Virtue trait weights</h3>
      <div class="ctrl">
        <label>Honesty <span><code id="lab_honesty">1.00</code></span></label>
        <input id="w_honesty" type="range" min="0" max="3" step="0.05" value="1.00" />
      </div>
      <div class="ctrl">
        <label>Compassion <span><code id="lab_compassion">1.00</code></span></label>
        <input id="w_compassion" type="range" min="0" max="3" step="0.05" value="1.00" />
      </div>
      <div class="ctrl">
        <label>Fairness <span><code id="lab_fairness">1.00</code></span></label>
        <input id="w_fairness" type="range" min="0" max="3" step="0.05" value="1.00" />
      </div>

      <div class="hr"></div>

      <button class="btn" id="reset">Reset</button>
    </div>

    <!-- Results -->
    <div id="results" class="results-list">
      <div class="card"><div class="empty">Loading scenariosâ€¦</div></div>
    </div>
  </div>

  <h2>Notes</h2>
  <ul class="muted">
    <li>Consequentialism reports normalized expected outcomes (life-years in triage, survivors in evacuation).</li>
    <li><strong>Rawls (maximin)</strong> scores an action by the welfare of the worst-off individual; normalized within each scenario.</li>
    <li>Virtue proxy combines honesty (promise-keeping), compassion (normalized outcomes), &amp; fairness (lottery/split bonus when options are close). Weights tune their influence.</li>
    <li>Promise rule: if enabled, breaking a credible promise is inadmissible unless expected harm avoided meets Î¸.</li>
  </ul>

  <p><a class="btn" href="index.html">Back to Home</a></p>
</main>

<footer class="wrap">
  Â© <span id="y"></span> Ethics Testbed Â· MIT License
</footer>

<script src="js/engine.js"></script>
<script>
  // ---------- Defaults ----------
  const defaults = {
    credences: { p_cons: 0.5, p_rawls: 0.25, p_virtue: 0.25 },
    promise:   { enabled: true, theta_lives: 1.5 },
    virtueWeights: { honesty: 1.0, compassion: 1.0, fairness: 1.0 }
  };
  const state = JSON.parse(JSON.stringify(defaults));
  document.getElementById('y').textContent = (new Date()).getFullYear();

  // ---------- UI ----------
  const ui = {
    p_cons: document.getElementById('p_cons'),
    p_rawls: document.getElementById('p_rawls'),
    p_virtue: document.getElementById('p_virtue'),
    lab_pcons: document.getElementById('lab_pcons'),
    lab_prawls: document.getElementById('lab_prawls'),
    lab_pvirtue: document.getElementById('lab_pvirtue'),

    promise_enabled: document.getElementById('promise_enabled'),
    theta_lives: document.getElementById('theta_lives'),
    lab_promise: document.getElementById('lab_promise'),
    lab_theta: document.getElementById('lab_theta'),

    w_honesty: document.getElementById('w_honesty'),
    w_compassion: document.getElementById('w_compassion'),
    w_fairness: document.getElementById('w_fairness'),
    lab_honesty: document.getElementById('lab_honesty'),
    lab_compassion: document.getElementById('lab_compassion'),
    lab_fairness: document.getElementById('lab_fairness'),

    reset: document.getElementById('reset'),

    bar_c: document.getElementById('bar_c'),
    bar_r: document.getElementById('bar_r'),
    bar_v: document.getElementById('bar_v'),
  };

  // ---------- Helpers ----------
  function fmt(x){
    if (x === null || x === undefined || Number.isNaN(x)) return 'â€”';
    if (typeof x === 'number') return x.toFixed(3);
    return String(x);
  }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  function renormCredences() {
    let c = parseFloat(ui.p_cons.value);
    let r = parseFloat(ui.p_rawls.value);
    let v = parseFloat(ui.p_virtue.value);
    const s = c + r + v;

    if (!isFinite(c) || !isFinite(r) || !isFinite(v) || s <= 0) { c = 1; r = 0; v = 0; }
    else { c /= s; r /= s; v /= s; }

    state.credences.p_cons = c; state.credences.p_rawls = r; state.credences.p_virtue = v;

    ui.lab_pcons.textContent = c.toFixed(2);
    ui.lab_prawls.textContent = r.toFixed(2);
    ui.lab_pvirtue.textContent = v.toFixed(2);

    ui.bar_c.style.width = (clamp01(c) * 100).toFixed(1) + '%';
    ui.bar_r.style.width = (clamp01(r) * 100).toFixed(1) + '%';
    ui.bar_v.style.width = (clamp01(v) * 100).toFixed(1) + '%';
  }

  function syncPromise() {
    state.promise.enabled = !!ui.promise_enabled.checked;
    state.promise.theta_lives = parseFloat(ui.theta_lives.value);
    ui.lab_promise.textContent = state.promise.enabled ? 'ON' : 'OFF';
    ui.lab_promise.classList.toggle('off', !state.promise.enabled);
    ui.lab_theta.textContent = (isFinite(state.promise.theta_lives) ? state.promise.theta_lives : 0).toFixed(2);
  }

  function syncVirtueWeights() {
    state.virtueWeights.honesty    = parseFloat(ui.w_honesty.value);
    state.virtueWeights.compassion = parseFloat(ui.w_compassion.value);
    state.virtueWeights.fairness   = parseFloat(ui.w_fairness.value);
    ui.lab_honesty.textContent     = (isFinite(state.virtueWeights.honesty)?state.virtueWeights.honesty:0).toFixed(2);
    ui.lab_compassion.textContent  = (isFinite(state.virtueWeights.compassion)?state.virtueWeights.compassion:0).toFixed(2);
    ui.lab_fairness.textContent    = (isFinite(state.virtueWeights.fairness)?state.virtueWeights.fairness:0).toFixed(2);
  }

  // ---------- Data loading (robust) ----------
  let scenarios = [];
  const container = document.getElementById('results');

  async function loadScenarios() {
    const url1 = `data/scenarios.json?v=${Date.now()}`;
    const url2 = `data/scenarios.min.json?v=${Date.now()}`;

    async function tryLoad(url){
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error(`Fetch failed: ${url} (${res.status})`);
      const raw = await res.json();
      if (Array.isArray(raw)) return raw;
      if (Array.isArray(raw.scenarios)) return raw.scenarios;
      if (Array.isArray(raw.items)) return raw.items;
      throw new Error('Unrecognized scenarios format');
    }

    try {
      scenarios = await tryLoad(url1);
    } catch(_e1) {
      try { scenarios = await tryLoad(url2); }
      catch(e2) {
        console.error(e2);
        container.innerHTML = `<div class="card"><div class="empty">Could not load scenarios. ${e2.message}</div></div>`;
        scenarios = [];
      }
    }
  }

  // ---------- Rendering ----------
  function renderScenario(scn, ev) {
    const card = document.createElement('div');
    card.className = 'card';

    const ranking = Array.isArray(ev?.ranking) ? ev.ranking : [];
    const bestId = ranking[0]?.[0] ?? null;
    const bestScore = ranking[0]?.[1];

    const inadmissible = [];
    try {
      for (const [k,v] of (ev?.admissibility?.entries?.() ?? [])) {
        if (v && v.admissible === false) inadmissible.push(`${k} â€” ${(v.reasons ?? []).join('; ')}`);
      }
    } catch {}

    const actions = (scn.actions || []).map(a => a.id);
    const rowHtml = id => {
      const consRaw  = ev?.consRaw?.get?.(id);
      const consNorm = ev?.consNorm?.get?.(id);
      const rawlsRaw = ev?.rawlsRaw?.get?.(id);
      const rawlsNorm= ev?.rawlsNorm?.get?.(id);
      const virtRaw  = ev?.virtueRaw?.get?.(id);
      const virtNorm = ev?.virtueNorm?.get?.(id);
      const agg      = ev?.aggregate?.get?.(id);
      const adm      = ev?.admissibility?.get?.(id);
      const isBest   = id === bestId;

      return `
        <tr class="${isBest ? 'best' : ''}">
          <td><code>${id}</code></td>
          <td>${fmt(consRaw)}</td>
          <td>${consNorm == null ? 'â€”' : Number(consNorm).toFixed(3)}</td>
          <td>${fmt(rawlsRaw)}</td>
          <td>${rawlsNorm == null ? 'â€”' : Number(rawlsNorm).toFixed(3)}</td>
          <td>${virtRaw == null ? 'â€”' : Number(virtRaw).toFixed(3)}</td>
          <td>${virtNorm == null ? 'â€”' : Number(virtNorm).toFixed(3)}</td>
          <td>${agg == null ? 'â€”' : Number(agg).toFixed(3)}</td>
          <td>${adm && adm.admissible !== false ? '<span class="pill">Yes</span>' : '<span class="pill bad">No</span>'}</td>
        </tr>`;
    };

    card.innerHTML = `
      <h2>${scn.id ?? 'Scenario'}</h2>
      <p class="muted">${scn.context?.domain ?? ''} ${scn.context?.tags?.length ? 'Â· ' + scn.context.tags.join(', ') : ''}</p>

      <p><strong>Top recommendation:</strong>
        ${bestId ? `<code>${bestId}</code> <span class="muted">(${Number(bestScore ?? NaN).toFixed(3)})</span>` : '<span class="muted">â€”</span>'}
      </p>

      <div class="table-wrap" role="region" aria-label="${scn.id ?? 'Scenario'} results" tabindex="0">
        <table class="table-results">
          <thead>
            <tr>
              <th>Action</th>
              <th>Cons. Raw</th>
              <th>Cons. Norm</th>
              <th>Rawls Raw</th>
              <th>Rawls Norm</th>
              <th>Virtue Raw</th>
              <th>Virtue Norm</th>
              <th>Aggregate</th>
              <th>Admissible</th>
            </tr>
          </thead>
          <tbody>
            ${actions.length ? actions.map(rowHtml).join('') : `<tr><td colspan="9" class="muted">No actions defined.</td></tr>`}
          </tbody>
        </table>
      </div>

      ${ranking.length ? `<p><strong>Ranking:</strong> ${ranking.map(([a,s]) => `<code>${a}</code> (${Number(s).toFixed(3)})`).join(' &gt; ')}</p>` : ''}
      ${inadmissible.length ? `<p><strong>Inadmissible:</strong> ${inadmissible.join(' | ')}</p>` : ''}
      ${Array.isArray(ev?.explanations) && ev.explanations.length ? `<p><strong>Explanation set:</strong> ${ev.explanations.join(' ')}</p>` : ''}
    `;
    return card;
  }

  function renderScenarioError(scn, err) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h2>${scn?.id ?? 'Scenario'}</h2>
      <p class="muted">${scn?.context?.domain ?? ''}</p>
      <div class="empty">This scenario could not be evaluated: ${err?.message ?? err}</div>
    `;
    return card;
  }

  function rerun() {
    const host = container;
    host.innerHTML = '';
    if (!Array.isArray(scenarios) || scenarios.length === 0) {
      host.innerHTML = `<div class="card"><div class="empty">No scenarios found.</div></div>`;
      return;
    }

    for (const scn of scenarios) {
      try {
        const ev = window.EthicsEngine.evaluateScenario(scn, state);
        host.appendChild(renderScenario(scn, ev));
      } catch (err) {
        console.error('Scenario evaluation failed:', scn?.id, err);
        host.appendChild(renderScenarioError(scn, err));
      }
    }
  }

  // ---------- Wire events ----------
  ui.p_cons.addEventListener('input', () => { renormCredences(); rerun(); });
  ui.p_rawls.addEventListener('input', () => { renormCredences(); rerun(); });
  ui.p_virtue.addEventListener('input', () => { renormCredences(); rerun(); });

  ui.promise_enabled.addEventListener('change', () => { syncPromise(); rerun(); });
  ui.theta_lives.addEventListener('input', () => { syncPromise(); rerun(); });

  ui.w_honesty.addEventListener('input', () => { syncVirtueWeights(); rerun(); });
  ui.w_compassion.addEventListener('input', () => { syncVirtueWeights(); rerun(); });
  ui.w_fairness.addEventListener('input', () => { syncVirtueWeights(); rerun(); });

  ui.reset.addEventListener('click', () => {
    Object.assign(state, JSON.parse(JSON.stringify(defaults)));
    ui.p_cons.value = defaults.credences.p_cons;
    ui.p_rawls.value = defaults.credences.p_rawls;
    ui.p_virtue.value = defaults.credences.p_virtue;

    ui.promise_enabled.checked = defaults.promise.enabled;
    ui.theta_lives.value = defaults.promise.theta_lives;

    ui.w_honesty.value = defaults.virtueWeights.honesty;
    ui.w_compassion.value = defaults.virtueWeights.compassion;
    ui.w_fairness.value = defaults.virtueWeights.fairness;

    renormCredences(); syncPromise(); syncVirtueWeights(); rerun();
  });

  // ---------- Boot ----------
  (async function main(){
    renormCredences(); syncPromise(); syncVirtueWeights();
    await loadScenarios();
    rerun();
  })();
</script>
<script src="assets/site.js"></script>
</body>
</html>
